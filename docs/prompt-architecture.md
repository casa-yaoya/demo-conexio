# プロンプト構成アーキテクチャ

## 概要

出力パネルに表示される「プロンプト」は、OpenAI Realtime APIに**そのまま**渡されるテキストとして設計される。
このプロンプトは、以下の4つの要素を合成して構成される。

```
合成プロンプト = ①モード毎の固定指示 ＋ ②人格設定 ＋ ③流れ設定 ＋ ④内容設定
```

---

## プロンプト構成要素

### ①モード毎の固定指示（Mode Instruction）

モード毎に固定された、プロンプトの冒頭に挿入される基本指示文。
AIの役割と基本的な振る舞いを定義する。

| モード | キー | 固定指示 |
|--------|------|----------|
| 確認モード | `confirmation` | あなたは先生の役として、相手が理解しているかを確認して。（問）と（正解）の組み合わせのリストを与えるので、これを元に、１つずつ問いかけて。 |
| 実践モード | `practice` | あなたはお客様を演じ、以下に示す役割を演じて。話し相手は、内容の文脈によって変わるが、営業マンや、接客スタッフなどである。 |
| 台本モード | `subtitle` | あなたはお客様として、相手の会話相手をして。ただし、あなたの発言は全て、下記に示される台本の通り、一語一句同じ内容を話して。相手の発言が、台本通りでなかったとしても、無視して自分のターンでは自分の発言を台本通りにして。 |
| お手本モード | `ai-demo` | あなたは優秀なスタッフとして、以下に指示される内容を解釈し、お客様相手に会話して。 |

### ②人格設定（Character Settings）

キャラクター選択に紐づく、AIの人格設定。
「あなたの設定：」として追加される。

```
あなたの設定：
- 名前: 高橋 明
- 年齢: 35歳
- 属性: IT企業 プロジェクトマネージャー
- 性格: 論理的で冷静、効率を重視する
- 口癖: 「具体的な数字で説明してください」
```

### ③流れ設定（Flow Settings）

「プロンプト生成スタート」時にモード毎に設定される、挙動設計のプロンプト。
話し方、終了条件、不正解時の反応などの設定が含まれる。

**設定元**: BuildPanel.vue のプロンプト生成ダイアログ

**設定項目**:
- 相手の話し方（フレンドリー / ていねい / 怖い）
- 終了条件（上限ターン数、終了コール）
- 不正解時の反応（確認モードのみ）

**話し方の詳細**:

| スタイル | キー | 詳細 |
|----------|------|------|
| フレンドリー | `friendly` | 端的に、伝えるべき内容を短く最低限で伝える。タメ口だが、優しい話し方。問いは、書かれている内容をそのまま使うこと。 |
| ていねい | `polite` | 端的に、伝えるべき内容を短く最低限で伝える。敬語で、優しい話し方。間違えても励ましてくれる。ただし、同じ内容の発言は繰り返さない。問いは、書かれている内容をそのまま使うこと。 |
| 怖い | `strict` | 端的に、伝えるべき内容を短く最低限で伝える。タメ口で、厳しく、気合をいれてくる。命令口調。問いは、書かれている内容をそのまま使うこと。 |

### ④内容設定（Content Settings）

設計パネルの「プロンプト生成」で作成される、各モード毎の具体的なトレーニング内容。
ポイント、台本、シチュエーション設定などが含まれる。

---

## プロンプト合成フロー

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          プロンプト合成フロー（4層構造）                         │
└─────────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  モード毎の  │  │  人格設定    │  │  流れ設定    │  │  内容設定    │
│  固定指示    │  │  (キャラ     │  │  (挙動設計)  │  │  (ポイント   │
│  (モード別   │  │   クター)    │  │              │  │   台本等)    │
│   固定文)    │  │              │  │              │  │              │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │                 │
       └─────────────────┴─────────────────┴─────────────────┘
                                   │
                                   ▼
                          ┌────────────────┐
                          │  プロンプト    │
                          │  合成処理      │
                          │  (mergePrompt) │
                          └────────┬───────┘
                                   │
                                   ▼
                          ┌────────────────┐
                          │  合成プロンプト │
                          │  (出力パネル   │
                          │   に表示)      │
                          └────────┬───────┘
                                   │
                                   ▼
                          ┌────────────────┐
                          │  OpenAI        │
                          │  Realtime API  │
                          └────────────────┘
```

---

## データ構造

### SystemPromptDisplay（内容設定表示用）

```typescript
interface SystemPromptDisplay {
  mode: string           // 表示名（例: '確認モード'）
  modeKey: string        // 内部キー（例: 'confirmation'）
  content: string        // 合成済みプロンプト本文
  isGenerating: boolean  // 生成中フラグ
}
```

### FlowSettings（流れ設定用）

```typescript
interface FlowSettings {
  speakingStyle: 'friendly' | 'polite' | 'strict'  // 話し方
  maxTurnCount: number                              // 上限ターン数
  endOnCall: boolean                                // 終了コール有効
  incorrectResponseType?: string                    // 不正解時の反応（確認モードのみ）
}
```

### MergedPrompt（合成済みプロンプト）

```typescript
interface MergedPrompt {
  modeInstruction: string    // ①モード毎の固定指示
  characterSettings: string  // ②人格設定
  flowSettings: string       // ③流れ設定
  contentSettings: string    // ④内容設定
  fullPrompt: string         // 合成後のプロンプト
}
```

### モード毎の固定指示定義

```typescript
const MODE_INSTRUCTIONS: Record<string, string> = {
  'confirmation': 'あなたは先生の役として、相手が理解しているかを確認して。（問）と（正解）の組み合わせのリストを与えるので、これを元に、１つずつ問いかけて。',
  'practice': 'あなたはお客様を演じ、以下に示す役割を演じて。話し相手は、内容の文脈によって変わるが、営業マンや、接客スタッフなどである。',
  'ai-demo': 'あなたは優秀なスタッフとして、以下に指示される内容を解釈し、お客様相手に会話して。',
  'subtitle': 'あなたはお客様として、相手の会話相手をして。ただし、あなたの発言は全て、下記に示される台本の通り、一語一句同じ内容を話して。相手の発言が、台本通りでなかったとしても、無視して自分のターンでは自分の発言を台本通りにして。'
}
```

---

## 実装箇所

| ファイル | 役割 |
|----------|------|
| `app/pages/content-creation.vue` | プロンプト合成ロジック（`mergedPrompt` computed） |
| `app/components/BuildPanel.vue` | 流れ設定UI、内容設定生成UI |
| `app/composables/useBasePrompts.ts` | モード毎の固定指示定義、流れ設定生成 |

---

## 用語対応表

| 旧称 | 新称 | 英語名 |
|------|------|--------|
| ベースプロンプト | モード毎の固定指示 | Mode Instruction |
| 人格プロンプト | 人格設定 | Character Settings |
| 設定プロンプト | 流れ設定 | Flow Settings |
| 内容プロンプト | 内容設定 | Content Settings |
| 最終プロンプト | 合成プロンプト | Merged Prompt |

---

## 更新履歴

- 2025-12-01: ネーミング変更。「〇〇プロンプト」から「〇〇設定」へ統一。
- 2025-12-01: 4層構造に変更。設定プロンプトを追加。
- 2025-12-01: 初版作成。プロンプト構成の3層アーキテクチャを定義。
