import { getOpenAIClient } from '../utils/openai'
import type { ResponseFormatJSONSchema } from 'openai/resources/shared'

interface GeneratePointsRequest {
  files: Array<{
    name: string
    content?: string
    dataType: string
  }>
  goals: string[]
  additionalInfo: string[]
  roleplayDesign?: any
}

// ãƒã‚¤ãƒ³ãƒˆã®ã‚«ãƒ†ã‚´ãƒª
type PointCategory = 'knowledge' | 'mindset' | 'speaking'

// ãƒã‚¤ãƒ³ãƒˆå½¢å¼
interface PointItem {
  category: PointCategory
  question: string
  point: string
  correctAnswer: string
}

interface GeneratePointsResponse {
  overview: string
  points: PointItem[]
}

// OpenAI Structured Outputsç”¨ã®JSON Schema
const pointsResponseSchema: ResponseFormatJSONSchema = {
  type: 'json_schema',
  json_schema: {
    name: 'points_response',
    strict: true,
    schema: {
      type: 'object',
      properties: {
        overview: {
          type: 'string',
          description: 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å…¨ä½“ã®ç›®çš„ã¨å†…å®¹ã®ã‚µãƒãƒªãƒ¼ï¼ˆ200æ–‡å­—ä»¥å†…ï¼‰'
        },
        points: {
          type: 'array',
          items: {
            type: 'object',
            properties: {
              category: {
                type: 'string',
                enum: ['knowledge', 'mindset', 'speaking'],
                description: 'ãƒã‚¤ãƒ³ãƒˆã®ã‚«ãƒ†ã‚´ãƒªï¼šknowledgeï¼ˆçŸ¥è­˜ï¼‰, mindsetï¼ˆè€ƒãˆæ–¹ï¼‰, speakingï¼ˆè©±ã—æ–¹ï¼‰'
              },
              question: {
                type: 'string',
                description: 'ç›´æ¥çš„ã§å…·ä½“çš„ãªè³ªå•ã€‚ã€Œã€œã‚’çŸ¥ã£ã¦ã‚‹ï¼Ÿã€ã§ã¯ãªãã€ŒVR1å°ã§ã„ãã‚‰ï¼Ÿã€ã®ã‚ˆã†ãªå½¢å¼'
              },
              point: {
                type: 'string',
                description: 'ç®‡æ¡æ›¸ãå½¢å¼ã§æ•´ç†ã•ã‚ŒãŸãƒã‚¤ãƒ³ãƒˆï¼ˆãƒ»ã§å§‹ã¾ã‚‹è¡Œï¼‰'
              },
              correctAnswer: {
                type: 'string',
                description: 'ãŠå®¢æ§˜ã«è©±ã™ã‚ˆã†ãªä¸å¯§ãªæ•¬èªè¡¨ç¾ã§ã®å›ç­”ä¾‹'
              }
            },
            required: ['category', 'question', 'point', 'correctAnswer'],
            additionalProperties: false
          }
        }
      },
      required: ['overview', 'points'],
      additionalProperties: false
    }
  }
}

// ã‚´ãƒ¼ãƒ«åˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®šç¾©
type GoalType = 'ForMemorize' | 'ForUnderstanding' | 'ForHearing' | 'ForOutReturn' | 'ForSpeaking'

// ã‚´ãƒ¼ãƒ«ãƒ©ãƒ™ãƒ«ã‹ã‚‰GoalTypeã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
const goalLabelToType: Record<string, GoalType> = {
  'å°æœ¬ã®æš—è¨˜': 'ForMemorize',
  'æ­£ç¢ºãªèª¬æ˜ã‚„è³ªå•': 'ForUnderstanding',
  'ãƒ’ã‚¢ãƒªãƒ³ã‚°': 'ForHearing',
  'è³ªç–‘ã‚„åè«–ã¸ã®åˆ‡ã‚Šè¿”ã—': 'ForOutReturn',
  'è©±ã—æ–¹': 'ForSpeaking'
}

// å„é …ç›®ã®èª¬æ˜ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã§ä½¿ç”¨ï¼‰
const fieldGuidelines = `
ã€å„é …ç›®ã®ä½œæˆã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã€‘
- overview: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å…¨ä½“ã®ç›®çš„ã¨å†…å®¹ã‚’ç°¡æ½”ã«ã¾ã¨ã‚ãŸã‚µãƒãƒªãƒ¼ã€‚200æ–‡å­—ä»¥å†…ã§è¨˜è¿°ã€‚
- category: "knowledge"ï¼ˆçŸ¥è­˜ï¼‰, "mindset"ï¼ˆè€ƒãˆæ–¹ï¼‰, "speaking"ï¼ˆè©±ã—æ–¹ï¼‰ã®ã„ãšã‚Œã‹
- questionï¼ˆå•ã„ã‹ã‘ï¼‰:
  âœ—NGä¾‹ï¼šã€Œã€œã‚’çŸ¥ã£ã¦ã‚‹ï¼Ÿã€ã€Œã€œã‚’è¦šãˆã¦ã„ã‚‹ï¼Ÿã€ã®ã‚ˆã†ãªé–“æ¥çš„ãªè³ªå•
  â—‹OKä¾‹ï¼šã€ŒVR1å°ã§ã„ãã‚‰ï¼Ÿã€ã€Œã“ã®ãƒ—ãƒ©ãƒ³ã®ç‰¹å¾´ã¯ï¼Ÿã€ã®ã‚ˆã†ãªç›´æ¥çš„ã§å…·ä½“çš„ãªè³ªå•
  â†’ãŠå®¢æ§˜ã‹ã‚‰èã‹ã‚Œãã†ãªè³ªå•ã€ã¾ãŸã¯çŸ¥ã£ã¦ãŠãã¹ãäº‹é …ã‚’ç«¯çš„ã«å•ã†å½¢å¼
- pointï¼ˆãƒã‚¤ãƒ³ãƒˆï¼‰:
  â†’å¿…ãšç®‡æ¡æ›¸ãå½¢å¼ã§æƒ…å ±ã‚’æ•´ç†ã—ã¦è¨˜è¿°ï¼ˆãƒ»ã§å§‹ã¾ã‚‹è¡Œï¼‰
  â†’ã‚»ãƒªãƒ•å½¢å¼ã‚„é•·æ–‡ã§ã¯ãªãã€é‡è¦ãªæƒ…å ±ã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã‚‹
- correctAnswerï¼ˆæ­£ç­”ä¾‹ï¼‰:
  â†’ãŠå®¢æ§˜ã«èª¬æ˜ã—ã¦ã„ã‚‹å£èª¿ã§ã€è³ªå•ã«å¯¾ã—ã¦ä¸å¯§ã«ç­”ãˆã‚‹å½¢
  â†’å®Ÿéš›ã®å–¶æ¥­ãƒˆãƒ¼ã‚¯ã®ã‚ˆã†ãªè‡ªç„¶ãªæ•¬èªè¡¨ç¾ã§è¨˜è¿°`

// ã‚´ãƒ¼ãƒ«åˆ¥ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
const goalPrompts: Record<GoalType, string> = {
  // â‘  å°æœ¬ã®æš—è¨˜
  ForMemorize: `ã‚ãªãŸã¯ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ç ”ä¿®ã®å°‚é–€å®¶ã§ã™ã€‚
ä¸ãˆã‚‰ã‚ŒãŸè³‡æ–™ã‹ã‚‰ã€ã€Œå°æœ¬ã®æš—è¨˜ã€ã‚’ç›®çš„ã¨ã—ãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

ã€å°æœ¬æš—è¨˜ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ç›®çš„ã€‘
- æ­£ç¢ºãªã‚»ãƒªãƒ•ã‚’è¦šãˆã¦ã€æ·€ã¿ãªãè¨€ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨
- è©±ã™é †åºã€ãƒ•ãƒ¬ãƒ¼ã‚ºã®æ­£ç¢ºãªå†ç¾ã‚’é‡è¦–
- ä¸¸æš—è¨˜ã™ã¹ãé‡è¦ãªã‚»ãƒªãƒ•ã‚„å®šå‹å¥ã‚’æŠ½å‡º

ã€é‡è¦–ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã€‘
1. knowledgeï¼ˆçŸ¥è­˜ï¼‰ï¼šæš—è¨˜ã™ã¹ãæ­£ç¢ºãªã‚»ãƒªãƒ•ã‚„å®šå‹å¥
   - æŒ¨æ‹¶æ–‡ã€å•†å“èª¬æ˜ã®å®šå‹ãƒ•ãƒ¬ãƒ¼ã‚ºã€ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ãƒˆãƒ¼ã‚¯ãªã©
   - ä¸€å­—ä¸€å¥æ­£ç¢ºã«è¨€ãˆã‚‹ã“ã¨ãŒé‡è¦ãªã‚‚ã®
   - correctAnswerã¯ã€Œã“ã®ã¾ã¾è¨€ã†ã€ã¹ãæ­£ç¢ºãªã‚»ãƒªãƒ•

2. mindsetï¼ˆè€ƒãˆæ–¹ï¼‰ï¼šå°æœ¬ã‚’è¦šãˆã‚‹éš›ã®ã‚³ãƒ„ã‚„å¿ƒæ§‹ãˆ
   - ãªãœãã®ãƒ•ãƒ¬ãƒ¼ã‚ºãŒåŠ¹æœçš„ãªã®ã‹
   - æš—è¨˜ã®ã‚³ãƒ„ã‚„ç·´ç¿’æ–¹æ³•

3. speakingï¼ˆè©±ã—æ–¹ï¼‰ï¼šã‚»ãƒªãƒ•ã‚’è¨€ã†éš›ã®å£°ã®ãƒˆãƒ¼ãƒ³ã‚„ã‚¿ã‚¤ãƒŸãƒ³ã‚°
   - æŠ‘æšã€é–“ã®å–ã‚Šæ–¹ã€å£°ã®å¤§ãã•
   - æ„Ÿæƒ…ã®è¾¼ã‚æ–¹

ã€å‡ºåŠ›ã®ç‰¹å¾´ã€‘
- knowledgeã‚«ãƒ†ã‚´ãƒªã‚’å¤šã‚ã«ï¼ˆ5å€‹ä»¥ä¸Šæ¨å¥¨ï¼‰
- correctAnswerã¯ã€Œãã®ã¾ã¾è¨€ã†ã¹ãæ­£ç¢ºãªã‚»ãƒªãƒ•ã€ã¨ã—ã¦è¨˜è¿°
- questionã¯ã€Œã€‡ã€‡ã®å ´é¢ã§ä½•ã¨è¨€ã†ï¼Ÿã€ã€Œæœ€åˆã«è¨€ã†ã¹ãã“ã¨ã¯ï¼Ÿã€ã®ã‚ˆã†ãªå½¢å¼
${fieldGuidelines}`,

  // â‘¡ æ­£ç¢ºãªèª¬æ˜ã‚„è³ªå•
  ForUnderstanding: `ã‚ãªãŸã¯ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ç ”ä¿®ã®å°‚é–€å®¶ã§ã™ã€‚
ä¸ãˆã‚‰ã‚ŒãŸè³‡æ–™ã‹ã‚‰ã€ã€Œæ­£ç¢ºãªèª¬æ˜ã‚„è³ªå•ã€ã‚’ç›®çš„ã¨ã—ãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

ã€æ­£ç¢ºãªèª¬æ˜ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ç›®çš„ã€‘
- å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã®ç‰¹å¾´ã‚’æ­£ç¢ºã«ç†è§£ã—èª¬æ˜ã§ãã‚‹ã“ã¨
- ãŠå®¢æ§˜ã®è³ªå•ã«å¯¾ã—ã¦ã€æ­£ã—ã„æƒ…å ±ã§å›ç­”ã§ãã‚‹ã“ã¨
- æ•°å­—ã‚„ã‚¹ãƒšãƒƒã‚¯ã€æ¡ä»¶ãªã©ã‚’é–“é•ãˆãšã«ä¼ãˆã‚‹ã“ã¨

ã€é‡è¦–ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã€‘
1. knowledgeï¼ˆçŸ¥è­˜ï¼‰ï¼šæ­£ç¢ºã«è¦šãˆã‚‹ã¹ãæƒ…å ±
   - ä¾¡æ ¼ã€æ©Ÿèƒ½ã€ã‚¹ãƒšãƒƒã‚¯ã€æ¡ä»¶ãªã©ã®å…·ä½“çš„æ•°å€¤
   - å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã®ç‰¹å¾´ã¨ä»–ç¤¾ã¨ã®é•ã„
   - ã‚ˆãã‚ã‚‹è³ªå•ã¨ãã®æ­£ç¢ºãªå›ç­”
   - ã€é‡è¦ã€‘ä¸ãˆã‚‰ã‚ŒãŸæƒ…å ±ã®ã¿ã§ã¾ã¨ã‚ã€æ¨æ¸¬ã‚’å…¥ã‚Œãªã„

2. mindsetï¼ˆè€ƒãˆæ–¹ï¼‰ï¼šæ­£ç¢ºã«èª¬æ˜ã™ã‚‹ãŸã‚ã®å¿ƒæ§‹ãˆ
   - ã‚ã‹ã‚‰ãªã„ã“ã¨ã¯èª¿ã¹ã‚‹å§¿å‹¢
   - æ›–æ˜§ãªå›ç­”ã‚’é¿ã‘ã‚‹æ„è­˜

3. speakingï¼ˆè©±ã—æ–¹ï¼‰ï¼šèª¬æ˜æ™‚ã®è©±ã—æ–¹ã®ã‚³ãƒ„
   - é‡è¦ãªæ•°å­—ã‚’å¼·èª¿ã™ã‚‹æ–¹æ³•
   - è¤‡é›‘ãªæƒ…å ±ã‚’ã‚ã‹ã‚Šã‚„ã™ãä¼ãˆã‚‹å·¥å¤«

ã€å‡ºåŠ›ã®ç‰¹å¾´ã€‘
- knowledgeã‚«ãƒ†ã‚´ãƒªã‚’æœ€ã‚‚å¤šãï¼ˆ6å€‹ä»¥ä¸Šæ¨å¥¨ï¼‰
- pointã«ã¯å…·ä½“çš„ãªæ•°å€¤ã‚„æ¡ä»¶ã‚’å¿…ãšå«ã‚ã‚‹
- questionã¯ã€Œä¾¡æ ¼ã¯ï¼Ÿã€ã€Œã€‡ã€‡ã®ç‰¹å¾´ã¯ï¼Ÿã€ã€Œã€‡ã€‡ã¨â–³â–³ã®é•ã„ã¯ï¼Ÿã€ã®ã‚ˆã†ãªå½¢å¼
${fieldGuidelines}`,

  // â‘¢ ãƒ’ã‚¢ãƒªãƒ³ã‚°
  ForHearing: `ã‚ãªãŸã¯ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ç ”ä¿®ã®å°‚é–€å®¶ã§ã™ã€‚
ä¸ãˆã‚‰ã‚ŒãŸè³‡æ–™ã‹ã‚‰ã€ã€Œãƒ’ã‚¢ãƒªãƒ³ã‚°åŠ›å‘ä¸Šã€ã‚’ç›®çš„ã¨ã—ãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

ã€ãƒ’ã‚¢ãƒªãƒ³ã‚°ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ç›®çš„ã€‘
- ãŠå®¢æ§˜ã®ãƒ‹ãƒ¼ã‚ºã‚„èª²é¡Œã‚’æ­£ç¢ºã«èãå‡ºã™ã“ã¨
- é©åˆ‡ãªè³ªå•ã§æ·±æ˜ã‚Šã™ã‚‹åŠ›ã‚’èº«ã«ã¤ã‘ã‚‹ã“ã¨
- èã„ãŸæƒ…å ±ã‚’æ•´ç†ã—ã€æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã¤ãªã’ã‚‹ã“ã¨

ã€é‡è¦–ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã€‘
1. knowledgeï¼ˆçŸ¥è­˜ï¼‰ï¼šãƒ’ã‚¢ãƒªãƒ³ã‚°ã™ã¹ãé …ç›®
   - èãã¹ãè³ªå•ãƒªã‚¹ãƒˆ
   - æ¥­ç•Œç‰¹æœ‰ã®èª²é¡Œãƒ‘ã‚¿ãƒ¼ãƒ³
   - ãŠå®¢æ§˜ãŒæŠ±ãˆã‚„ã™ã„æ‚©ã¿ã‚„å•é¡Œ

2. mindsetï¼ˆè€ƒãˆæ–¹ï¼‰ï¼šãƒ’ã‚¢ãƒªãƒ³ã‚°æ™‚ã®å¿ƒæ§‹ãˆ
   - å‚¾è´ã®å§¿å‹¢ã€å…±æ„Ÿã®ç¤ºã—æ–¹
   - ã€Œãªãœï¼Ÿã€ã‚’æ·±æ˜ã‚Šã™ã‚‹æ„è­˜
   - ãŠå®¢æ§˜ã®æœ¬éŸ³ã‚’å¼•ãå‡ºã™ã‚³ãƒ„

3. speakingï¼ˆè©±ã—æ–¹ï¼‰ï¼šãƒ’ã‚¢ãƒªãƒ³ã‚°æ™‚ã®è©±ã—æ–¹
   - è³ªå•ã®ä»•æ–¹ï¼ˆã‚ªãƒ¼ãƒ—ãƒ³/ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ã‚¯ã‚¨ã‚¹ãƒãƒ§ãƒ³ï¼‰
   - ç›¸æ§Œã®æ‰“ã¡æ–¹ã€æ²ˆé»™ã®æ´»ç”¨

ã€å‡ºåŠ›ã®ç‰¹å¾´ã€‘
- mindsetã‚«ãƒ†ã‚´ãƒªã‚’å¤šã‚ã«ï¼ˆ4å€‹ä»¥ä¸Šï¼‰
- questionã¯ã€Œã©ã†ã‚„ã£ã¦æ·±æ˜ã‚Šã™ã‚‹ï¼Ÿã€ã€Œã€‡ã€‡ã¨è¨€ã‚ã‚ŒãŸã‚‰ä½•ã‚’èãï¼Ÿã€ã®ã‚ˆã†ãªå½¢å¼
- correctAnswerã¯è³ªå•ä¾‹ã‚’å«ã‚ã‚‹
${fieldGuidelines}`,

  // â‘£ è³ªç–‘ã‚„åè«–ã¸ã®åˆ‡ã‚Šè¿”ã—
  ForOutReturn: `ã‚ãªãŸã¯ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ç ”ä¿®ã®å°‚é–€å®¶ã§ã™ã€‚
ä¸ãˆã‚‰ã‚ŒãŸè³‡æ–™ã‹ã‚‰ã€ã€Œè³ªç–‘ã‚„åè«–ã¸ã®åˆ‡ã‚Šè¿”ã—ã€ã‚’ç›®çš„ã¨ã—ãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

ã€åˆ‡ã‚Šè¿”ã—ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ç›®çš„ã€‘
- ãŠå®¢æ§˜ã‹ã‚‰ã®è³ªå•ã‚„åè«–ã«é©åˆ‡ã«å¯¾å¿œã§ãã‚‹ã“ã¨
- ç›¸æ‰‹ã‚’å¦å®šã›ãšã«å»ºè¨­çš„ãªä¼šè©±ã‚’ç¶šã‘ã‚‹ã“ã¨
- å³ã—ã„è³ªå•ã«ã‚‚å†·é™ã«å¯¾å‡¦ã§ãã‚‹ã“ã¨

ã€é‡è¦–ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã€‘
1. knowledgeï¼ˆçŸ¥è­˜ï¼‰ï¼šã‚ˆãã‚ã‚‹è³ªå•ãƒ»åè«–ã¨ãã®å¯¾å¿œ
   - ã€Œä¾¡æ ¼ãŒé«˜ã„ã€ã€Œä»Šã¯å¿…è¦ãªã„ã€ã€Œä»–ç¤¾ã¨æ¯”è¼ƒã—ãŸã„ã€ãªã©ã®å®šç•ªåè«–
   - å„åè«–ã¸ã®å…·ä½“çš„ãªåˆ‡ã‚Šè¿”ã—ãƒˆãƒ¼ã‚¯
   - ç«¶åˆä»–ç¤¾ã¨ã®æ¯”è¼ƒæƒ…å ±

2. mindsetï¼ˆè€ƒãˆæ–¹ï¼‰ï¼šåè«–å¯¾å¿œæ™‚ã®å¿ƒæ§‹ãˆ
   - åè«–ã¯èˆˆå‘³ã®è¡¨ã‚Œã¨ã„ã†è€ƒãˆæ–¹
   - æ„Ÿæƒ…çš„ã«ãªã‚‰ãªã„è‡ªå·±ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
   - ç›¸æ‰‹ã®ç«‹å ´ã«ç«‹ã£ãŸå¯¾å¿œ

3. speakingï¼ˆè©±ã—æ–¹ï¼‰ï¼šåˆ‡ã‚Šè¿”ã—æ™‚ã®è©±ã—æ–¹
   - ã¾ãšå—ã‘æ­¢ã‚ã‚‹ï¼ˆYes, and...ï¼‰ã®æŠ€æ³•
   - è½ã¡ç€ã„ãŸãƒˆãƒ¼ãƒ³ã®ç¶­æŒ
   - è³ªå•ã§è¿”ã™æŠ€æ³•

ã€å‡ºåŠ›ã®ç‰¹å¾´ã€‘
- knowledgeã‚«ãƒ†ã‚´ãƒªã§ã¯å…·ä½“çš„ãªåè«–ã¨åˆ‡ã‚Šè¿”ã—ä¾‹ã‚’æç¤º
- questionã¯ã€Œã€‡ã€‡ã¨è¨€ã‚ã‚ŒãŸã‚‰ã©ã†è¿”ã™ï¼Ÿã€ã€Œä¾¡æ ¼ãŒé«˜ã„ã¨è¨€ã‚ã‚ŒãŸã‚‰ï¼Ÿã€ã®ã‚ˆã†ãªå½¢å¼
- correctAnswerã¯å…·ä½“çš„ãªåˆ‡ã‚Šè¿”ã—ã‚»ãƒªãƒ•ã‚’å«ã‚ã‚‹
${fieldGuidelines}`,

  // â‘¤ è©±ã—æ–¹
  ForSpeaking: `ã‚ãªãŸã¯ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ç ”ä¿®ã®å°‚é–€å®¶ã§ã™ã€‚
ä¸ãˆã‚‰ã‚ŒãŸè³‡æ–™ã‹ã‚‰ã€ã€Œè©±ã—æ–¹ã®å‘ä¸Šã€ã‚’ç›®çš„ã¨ã—ãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

ã€è©±ã—æ–¹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ç›®çš„ã€‘
- å£°ã®ãƒˆãƒ¼ãƒ³ã€é€Ÿåº¦ã€æŠ‘æšã‚’é©åˆ‡ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã“ã¨
- ç›¸æ‰‹ã«å¥½å°è±¡ã‚’ä¸ãˆã‚‹è©±ã—æ–¹ã‚’èº«ã«ã¤ã‘ã‚‹ã“ã¨
- ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã«å¿œã˜ãŸè©±ã—æ–¹ã®ä½¿ã„åˆ†ã‘ãŒã§ãã‚‹ã“ã¨

ã€é‡è¦–ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã€‘
1. knowledgeï¼ˆçŸ¥è­˜ï¼‰ï¼šè©±ã—æ–¹ã®åŸºæœ¬çŸ¥è­˜
   - å£°ã®å¤§ãã•ã€é€Ÿåº¦ã€ãƒˆãƒ¼ãƒ³ã®åŸºæº–
   - ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³åˆ¥ã®è©±ã—æ–¹ãƒ‘ã‚¿ãƒ¼ãƒ³
   - é¿ã‘ã‚‹ã¹ãè©±ã—æ–¹ï¼ˆå£ç™–ã€æ—©å£ãªã©ï¼‰

2. mindsetï¼ˆè€ƒãˆæ–¹ï¼‰ï¼šè©±ã—æ–¹ã‚’æ„è­˜ã™ã‚‹å¿ƒæ§‹ãˆ
   - ç›¸æ‰‹ã®åå¿œã‚’è¦‹ãªãŒã‚‰èª¿æ•´ã™ã‚‹æ„è­˜
   - è‡ªåˆ†ã®è©±ã—æ–¹ã®ç™–ã‚’èªè­˜ã™ã‚‹ã“ã¨
   - ç·´ç¿’ã®é‡è¦æ€§

3. speakingï¼ˆè©±ã—æ–¹ï¼‰ï¼šå…·ä½“çš„ãªè©±ã—æ–¹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯
   - é–“ã®å–ã‚Šæ–¹ã€å¼·èª¿ã®ä»•æ–¹
   - è¡¨æƒ…ã¨å£°ã®é€£å‹•
   - æ•¬èªã®æ­£ã—ã„ä½¿ã„æ–¹
   - èªå°¾ã‚’æ˜ç¢ºã«ã™ã‚‹

ã€å‡ºåŠ›ã®ç‰¹å¾´ã€‘
- speakingã‚«ãƒ†ã‚´ãƒªã‚’æœ€ã‚‚å¤šãï¼ˆ5å€‹ä»¥ä¸Šæ¨å¥¨ï¼‰
- questionã¯ã€Œã€‡ã€‡ã‚’èª¬æ˜ã™ã‚‹æ™‚ã®å£°ã®ãƒˆãƒ¼ãƒ³ã¯ï¼Ÿã€ã€Œé‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’ã©ã†å¼·èª¿ã™ã‚‹ï¼Ÿã€ã®ã‚ˆã†ãªå½¢å¼
- correctAnswerã¯è©±ã—æ–¹ã®ãƒã‚¤ãƒ³ãƒˆã‚’å«ã‚ãŸã‚»ãƒªãƒ•ä¾‹
${fieldGuidelines}`
}

// ã‚´ãƒ¼ãƒ«ã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é¸æŠã™ã‚‹é–¢æ•°
function getPromptForGoals(goals: string[]): string {
  // ã‚´ãƒ¼ãƒ«ã‚’GoalTypeã«å¤‰æ›
  const goalTypes: GoalType[] = goals
    .map(goal => goalLabelToType[goal])
    .filter((type): type is GoalType => type !== undefined)

  // ã‚´ãƒ¼ãƒ«ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  if (goalTypes.length === 0) {
    return goalPrompts.ForUnderstanding
  }

  // å˜ä¸€ã‚´ãƒ¼ãƒ«ã®å ´åˆ
  if (goalTypes.length === 1) {
    return goalPrompts[goalTypes[0]]
  }

  // è¤‡æ•°ã‚´ãƒ¼ãƒ«ã®å ´åˆã¯çµ„ã¿åˆã‚ã›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
  const combinedPrompt = `ã‚ãªãŸã¯ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ç ”ä¿®ã®å°‚é–€å®¶ã§ã™ã€‚
ä¸ãˆã‚‰ã‚ŒãŸè³‡æ–™ã‹ã‚‰ã€ä»¥ä¸‹ã®è¤‡åˆç›®çš„ã«å¯¾å¿œã—ãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ç›®çš„ã€‘
${goalTypes.map(type => {
  const labels: Record<GoalType, string> = {
    ForMemorize: 'å°æœ¬ã®æš—è¨˜ï¼šæ­£ç¢ºãªã‚»ãƒªãƒ•ã‚’è¦šãˆã¦æ·€ã¿ãªãè¨€ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨',
    ForUnderstanding: 'æ­£ç¢ºãªèª¬æ˜ï¼šå•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã®ç‰¹å¾´ã‚’æ­£ç¢ºã«èª¬æ˜ã§ãã‚‹ã“ã¨',
    ForHearing: 'ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼šãŠå®¢æ§˜ã®ãƒ‹ãƒ¼ã‚ºã‚„èª²é¡Œã‚’æ­£ç¢ºã«èãå‡ºã™ã“ã¨',
    ForOutReturn: 'åˆ‡ã‚Šè¿”ã—ï¼šè³ªå•ã‚„åè«–ã«é©åˆ‡ã«å¯¾å¿œã§ãã‚‹ã“ã¨',
    ForSpeaking: 'è©±ã—æ–¹ï¼šå£°ã®ãƒˆãƒ¼ãƒ³ã‚„é€Ÿåº¦ã‚’é©åˆ‡ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã“ã¨'
  }
  return `- ${labels[type]}`
}).join('\n')}

ã€ãƒã‚¤ãƒ³ãƒˆã®3åˆ†é¡ã€‘
1. knowledgeï¼ˆçŸ¥è­˜ï¼‰ï¼šè¦šãˆã‚‹ã¹ãæƒ…å ±ã€æ­£ç¢ºã«ä¼ãˆã‚‹ã¹ãå†…å®¹
2. mindsetï¼ˆè€ƒãˆæ–¹ï¼‰ï¼šå¿ƒæ§‹ãˆã€æ„è­˜ã™ã¹ãã“ã¨
3. speakingï¼ˆè©±ã—æ–¹ï¼‰ï¼šå£°ã®å‡ºã—æ–¹ã€è©±ã™ã‚¹ãƒ”ãƒ¼ãƒ‰ã€é–“ã®å–ã‚Šæ–¹

ã€å„ã‚´ãƒ¼ãƒ«ã«å¯¾å¿œã—ãŸãƒã‚¤ãƒ³ãƒˆé…åˆ†ã€‘
${goalTypes.includes('ForMemorize') ? '- å°æœ¬æš—è¨˜ç”¨ï¼šæš—è¨˜ã™ã¹ãæ­£ç¢ºãªã‚»ãƒªãƒ•ã‚„å®šå‹å¥' : ''}
${goalTypes.includes('ForUnderstanding') ? '- èª¬æ˜ç”¨ï¼šæ­£ç¢ºãªæ•°å€¤ã‚„ç‰¹å¾´ã€ã‚ˆãã‚ã‚‹è³ªå•ã¸ã®å›ç­”' : ''}
${goalTypes.includes('ForHearing') ? '- ãƒ’ã‚¢ãƒªãƒ³ã‚°ç”¨ï¼šèãã¹ãè³ªå•ã€æ·±æ˜ã‚Šã®ã‚³ãƒ„' : ''}
${goalTypes.includes('ForOutReturn') ? '- åˆ‡ã‚Šè¿”ã—ç”¨ï¼šåè«–ã¸ã®å¯¾å¿œãƒ‘ã‚¿ãƒ¼ãƒ³' : ''}
${goalTypes.includes('ForSpeaking') ? '- è©±ã—æ–¹ç”¨ï¼šå£°ã®ãƒˆãƒ¼ãƒ³ã€æŠ‘æšã€é–“ã®å–ã‚Šæ–¹' : ''}
${fieldGuidelines}`

  return combinedPrompt
}

export default defineEventHandler(async (event): Promise<GeneratePointsResponse> => {
  const body = await readBody<GeneratePointsRequest>(event)
  const { files = [], goals = [], additionalInfo = [], roleplayDesign } = body

  console.log('ğŸ“‹ Generating points summary...')
  console.log('ğŸ¯ Goals:', goals)

  try {
    const openai = getOpenAIClient()

    // ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’æ•´ç†
    const fileContents = files.map(f => `ã€${f.dataType}ã€‘${f.name}:\n${f.content || 'å†…å®¹ãªã—'}`).join('\n\n')
    const goalsText = goals.length > 0 ? goals.join('ã€') : 'ç‰¹ã«ãªã—'
    const additionalText = additionalInfo.length > 0 ? additionalInfo.join('\n') : 'ç‰¹ã«ãªã—'

    // ã‚´ãƒ¼ãƒ«ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
    const systemPrompt = getPromptForGoals(goals)

    const response = await openai.chat.completions.create({
      model: 'gpt-4o',
      max_tokens: 8192,
      response_format: pointsResponseSchema,
      messages: [
        {
          role: 'system',
          content: systemPrompt
        },
        {
          role: 'user',
          content: `ä»¥ä¸‹ã®æƒ…å ±ã‹ã‚‰ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ¦‚è¦ã¨ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã§ç¿’å¾—ã™ã¹ããƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ã‚´ãƒ¼ãƒ«ã€‘
${goalsText}

ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸè³‡æ–™ã€‘
${fileContents}

ã€è¿½åŠ æƒ…å ±ã€‘
${additionalText}

${roleplayDesign ? `ã€ãƒ­ãƒ¼ãƒ—ãƒ¬è¨­è¨ˆã€‘\n${JSON.stringify(roleplayDesign, null, 2)}` : ''}

ä¸Šè¨˜ã‚’è¸ã¾ãˆã¦ã€overviewã€ãã—ã¦category, question, point, correctAnswerã®ã‚»ãƒƒãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
knowledgeã‚«ãƒ†ã‚´ãƒªã¯ä¸ãˆã‚‰ã‚ŒãŸæƒ…å ±ã®ã¿ã§ã¾ã¨ã‚ã€æƒ…å ±ãŒä¸ååˆ†ãªå ´åˆã¯ç„¡ç†ã«ä½œæˆã—ãªã„ã§ãã ã•ã„ã€‚`
        }
      ]
    })

    const content = response.choices[0]?.message?.content || '{}'

    // Structured Outputsã«ã‚ˆã‚Šå¸¸ã«æ­£ã—ã„JSONå½¢å¼ãŒä¿è¨¼ã•ã‚Œã‚‹
    let overview = ''
    let points: PointItem[] = []
    try {
      const parsed = JSON.parse(content)
      overview = parsed.overview || ''
      points = parsed.points || []
    } catch (parseError) {
      console.error('JSON parse error:', parseError)
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆé€šå¸¸ã¯ç™ºç”Ÿã—ãªã„ï¼‰
      overview = 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®æ¦‚è¦ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚'
      points = getDefaultPoints(goals)
    }

    console.log(`âœ… Generated overview and ${points.length} points`)
    return { overview, points }
  } catch (error: any) {
    console.error('Generate Points API Error:', error)

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    return {
      overview: 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®æ¦‚è¦ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚',
      points: getDefaultPoints(goals)
    }
  }
})

// ã‚´ãƒ¼ãƒ«ã«å¿œã˜ãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒã‚¤ãƒ³ãƒˆã‚’è¿”ã™
function getDefaultPoints(goals: string[]): PointItem[] {
  const defaultPoints: PointItem[] = []

  if (goals.includes('å°æœ¬ã®æš—è¨˜')) {
    defaultPoints.push({
      category: 'knowledge',
      question: 'æœ€åˆã®æŒ¨æ‹¶ã¯ä½•ã¨è¨€ã†ï¼Ÿ',
      point: 'ãƒ»ã€ŒãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€ã‹ã‚‰å§‹ã‚ã‚‹\nãƒ»ä¼šç¤¾åã¨åå‰ã‚’æ˜ç¢ºã«ä¼ãˆã‚‹',
      correctAnswer: 'ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚ã€‡ã€‡ä¼šç¤¾ã®â–³â–³ã¨ç”³ã—ã¾ã™ã€‚æœ¬æ—¥ã¯ãŠæ™‚é–“ã‚’ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚'
    })
  }

  if (goals.includes('æ­£ç¢ºãªèª¬æ˜ã‚„è³ªå•')) {
    defaultPoints.push({
      category: 'knowledge',
      question: 'å•†å“ã®ç‰¹å¾´ã¯ï¼Ÿ',
      point: 'ãƒ»ä¸»è¦ãªæ©Ÿèƒ½ã‚’3ã¤ç¨‹åº¦ã«çµã‚‹\nãƒ»æ•°å­—ã§è¡¨ã›ã‚‹ãƒ¡ãƒªãƒƒãƒˆã‚’ä¼ãˆã‚‹',
      correctAnswer: 'å…·ä½“çš„ãªå•†å“æƒ…å ±ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã‚ˆã‚Šé©åˆ‡ãªãƒã‚¤ãƒ³ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚'
    })
  }

  if (goals.includes('ãƒ’ã‚¢ãƒªãƒ³ã‚°')) {
    defaultPoints.push({
      category: 'mindset',
      question: 'ãƒ’ã‚¢ãƒªãƒ³ã‚°ã§æœ€ã‚‚å¤§åˆ‡ãªã“ã¨ã¯ï¼Ÿ',
      point: 'ãƒ»è¡¨é¢çš„ãªè¦æœ›ã®èƒŒæ™¯ã‚’æ¢ã‚‹\nãƒ»ã€Œãªãœï¼Ÿã€ã‚’æ·±æ˜ã‚Šã™ã‚‹\nãƒ»ãŠå®¢æ§˜è‡ªèº«ã‚‚æ°—ã¥ã„ã¦ã„ãªã„èª²é¡Œã‚’è¦‹ã¤ã‘ã‚‹',
      correctAnswer: 'ãŠå®¢æ§˜ãŒãŠã£ã—ã‚ƒã‚‹ã“ã¨ã‚’ãã®ã¾ã¾å—ã‘å–ã‚‹ã ã‘ã§ãªãã€ãã®èƒŒæ™¯ã«ã‚ã‚‹æœ¬å½“ã®ãŠå›°ã‚Šã”ã¨ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚'
    })
  }

  if (goals.includes('è³ªç–‘ã‚„åè«–ã¸ã®åˆ‡ã‚Šè¿”ã—')) {
    defaultPoints.push({
      category: 'knowledge',
      question: 'ã€Œä¾¡æ ¼ãŒé«˜ã„ã€ã¨è¨€ã‚ã‚ŒãŸã‚‰ï¼Ÿ',
      point: 'ãƒ»ã¾ãšå…±æ„Ÿã‚’ç¤ºã™\nãƒ»ä¾¡æ ¼ã«è¦‹åˆã†ä¾¡å€¤ã‚’å…·ä½“çš„ã«èª¬æ˜\nãƒ»è²»ç”¨å¯¾åŠ¹æœã‚’æ•°å­—ã§ç¤ºã™',
      correctAnswer: 'ãŠã£ã—ã‚ƒã‚‹é€šã‚Šã€åˆæœŸè²»ç”¨ã¨ã—ã¦ã¯æ±ºã—ã¦å®‰ãã¯ã”ã–ã„ã¾ã›ã‚“ã€‚ãŸã ã€ã€‡ã€‡ã®åŠ¹æœã«ã‚ˆã‚Šâ–³â–³ã®å‰Šæ¸›ãŒè¦‹è¾¼ã‚ã¾ã™ã®ã§ã€â–¡â–¡ãƒ¶æœˆã§ãƒšã‚¤ã§ãã‚‹è¨ˆç®—ã«ãªã‚Šã¾ã™ã€‚'
    })
  }

  if (goals.includes('è©±ã—æ–¹')) {
    defaultPoints.push({
      category: 'speaking',
      question: 'å•†å“èª¬æ˜æ™‚ã®è©±ã—æ–¹ã®ã‚³ãƒ„ã¯ï¼Ÿ',
      point: 'ãƒ»è½ã¡ç€ã„ãŸãƒˆãƒ¼ãƒ³ã§è‡ªä¿¡ã‚’æŒã£ã¦\nãƒ»é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã§ã¯é–“ã‚’ç½®ã\nãƒ»ãŠå®¢æ§˜ã®åå¿œã‚’ç¢ºèªã—ãªãŒã‚‰é€²ã‚ã‚‹',
      correctAnswer: 'å•†å“ã®ã”èª¬æ˜ã‚’ã™ã‚‹éš›ã¯ã€ã‚†ã£ãã‚Šã¨è½ã¡ç€ã„ãŸå£°ã§ãŠè©±ã—ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«å¤§äº‹ãªãƒã‚¤ãƒ³ãƒˆã§ã¯å°‘ã—é–“ã‚’å–ã£ã¦ã€ãŠå®¢æ§˜ãŒã”ç†è§£ã„ãŸã ã‘ã¦ã„ã‚‹ã‹ãŠé¡”ã‚’è¦‹ãªãŒã‚‰é€²ã‚ã¦ã„ãã¾ã™ã€‚'
    })
  }

  // ã‚´ãƒ¼ãƒ«ãŒç©ºã®å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  if (defaultPoints.length === 0) {
    defaultPoints.push(
      {
        category: 'mindset',
        question: 'ãŠå®¢æ§˜ã®è¦æœ›ã‚’èãéš›ã®ãƒã‚¤ãƒ³ãƒˆã¯ï¼Ÿ',
        point: 'ãƒ»å‚¾è´ã®å§¿å‹¢ã‚’ç¤ºã™\nãƒ»é©åˆ‡ãªç›¸æ§Œã‚’æ‰“ã¤\nãƒ»ãƒ¡ãƒ¢ã‚’å–ã‚‹',
        correctAnswer: 'å‚¾è´ã®å§¿å‹¢ã‚’ç¤ºã—ã€é©åˆ‡ãªè³ªå•ã§æ·±æ˜ã‚Šã™ã‚‹ã“ã¨ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚'
      },
      {
        category: 'speaking',
        question: 'åŸºæœ¬çš„ãªæŒ¨æ‹¶ã®ä»•æ–¹ã¯ï¼Ÿ',
        point: 'ãƒ»æ˜ã‚‹ãã¯ã£ãã‚Šã¨\nãƒ»ç›¸æ‰‹ã®ç›®ã‚’è¦‹ã‚‹\nãƒ»ç¬‘é¡”ã‚’å¿˜ã‚Œãšã«',
        correctAnswer: 'æ˜ã‚‹ãå…ƒæ°—ã«ã€ç›¸æ‰‹ã®ç›®ã‚’è¦‹ã¦ç¬‘é¡”ã§æŒ¨æ‹¶ã™ã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚'
      }
    )
  }

  return defaultPoints
}
